---
title: "Project"
output:
  pdf_document: default
  html_document: default
date: "2024-10-24"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = T)

# Set the correct default repository
r = getOption("repos")
r["CRAN"] = "http://cran.rstudio.com"
options(repos = r)


# These will install required packages if they are not already installed
if (!require("ggplot2")) {
   install.packages("ggplot2")
   library(ggplot2)
}
if (!require("knitr")) {
   install.packages("knitr")
   library(knitr)
}
if (!require("xtable")) {
   install.packages("xtable")
   library(xtable)
}
if (!require("pander")) {
   install.packages("pander")
   library(pander)
}

if (!require("devtools")) {
  install.packages("devtools" ) 
  library(devtools)
}

if (!require("usethis")) {
  install.packages("usethis" ) 
  library(usethis)
}

if (!require("e1071")) {
 install.packages("e1071" ) 
  library(e1071)
}

if (!require("pROC")){
  install.packages("pROC")
   library(pROC)
} 

if (!require("dplyr")) {
   install.packages("dplyr")
   library(dplyr)
}

if (!require("tidyverse")) {
   install.packages("tidyverse")
   library(tidyverse)
}

if (!require("caret")) {
   install.packages("caret")
   library(caret)
}

if (!require("formattable")) {
   install.packages("formattable")
   library(formattable)
}

if (!require("glmnet")) {
   install.packages("glmnet")
   library(glmnet)
}

if (!require("adabag")) {
   install.packages("adabag")
   library(adabag)
}

if (!require("ada")) {
   install.packages("ada")
   library(ada)
}


if (!require("corrplot")) {
   install.packages("corrplot")
   library(corrplot)
}
if (!require("xgboost")) {
   install.packages("xgboost")
   library(xgboost)
}
if (!require("car")) {
   install.packages("car")
   library(car)
}
if (!require("maps")) {
   install.packages("maps")
   library(maps)
}
if (!require("mapproj")) {
   install.packages("mapproj")
   library(mapproj)
}
if (!require("stargazer")) {
   install.packages("stargazer")
   library(stargazer)
}
if (!require("sandwich")) {
   install.packages("sandwich")
   library(sandwich)
}
if (!require("lmtest")) {
   install.packages("lmtest")
   library(lmtest)
}


knitr::opts_chunk$set(echo = TRUE)
some_na <- function(x) any(is.na(x))
```

```{r,include=FALSE, cache=FALSE}
acs <- readRDS("acs.rds")
```



## ACS Analysis

This section used the detailed data from the American Community Survey (ACS), an annual survey conducted by the U.S. Census Bureau that captures key social, economic, housing, and demographic information across the United States (https://www.census.gov/programs-surveys/acs/). The ACS dataset is a comprehensive resource for understanding the factors influencing rental housing prices. Specifically, the data includes demographic, geographic, and housing information summarized by FIPS (Federal Information Processing Standards) codes, which "[...] are assigned alphabetically by geographic name for states, counties, core based statistical areas, places, county subdivisions, consolidated cities and all types of American Indian, Alaska Native, and Native Hawaiian (AIANNH) areas." (https://www.census.gov/programs-surveys/geography/guidance/geo-identifiers.html) 

Our analysis seeks to identify the variables that significantly impact rental housing prices and quantify their effect. We focus on demographic factors such as household income, geographic indicators like metropolitan status, and structural features of houses to examine their contributions to rental price variations.

Given the self-reporting status of housing value in the dataset, we concluded that rental prices were a more accurate measure of house value. For this reason, we decided to conduct our analysis using this as our dependent variable. By applying robust statistical methods we provide a deep exploration of the determinants of housing rental prices. This approach assumes that these determinants are strongly correlated, if not identical to, the determinants of housing prices.

### Data Description

The dataset used in this study includes observations on rental housing units from the most recent ACS. Key variables of interest include:

* Monthly Rental Price: The dependent variable, representing the self-reported cost of renting a housing unit.

* Demographic Variables: These include household income, age of the householder, population density.

* Housing Characteristics: Information about the number of bedrooms, age of the property, kitchen and plumbing inclusion, and room number.

* Geographic Variables: Metropolitan versus rural location, and proximity to major urban centers.

The data was cleaned to ensure accuracy and consistency. The total number of observations was 56,835,321 with 29 features but after removing rows with missing or NA values for rental price or explanatory variables (76.5%) and selecting important features, we were left with 13,341,750 observations with 15 features. 

The following code block cleans the data:

```{r}
# Not including taxincl, insincl and debt_incurred because first two only have zero
# and last one only has false

#year_from_start is perfectly correlated with year so we removed it.

data <- acs %>% select(year, density, metro, fips,
                        hhincome,
                        rooms, builtyr2, unitsstr, bedrooms,
                        age, married, male,
                        complete_plumbing, has_kitchen, cpi_rent) %>%
  na.omit() %>%
  mutate(year = as.factor(year)) %>%
  mutate(fips_state = as.factor(substr(fips, 1, 2))) %>%
  select(year, density, metro, fips_state, fips,
                        hhincome,
                        rooms, builtyr2, unitsstr, bedrooms,
                        age, married, male,
                        complete_plumbing, has_kitchen, cpi_rent)
  
```

The dataset includes observations from counties across the United States. However, due to challenges in obtaining complete information and the presence of missing values in the FIPS column, the data is limited to specific counties. These counties are highlighted in red on the map below. While the map may appear significantly incomplete, it is important to note that we have data from every state in the country.


```{r, warning=FALSE}
maps::county.fips %>%
  as.tibble %>% 
  extract(polyname, c("region", "subregion"), "^([^,]+),([^,]+)$") ->
  dfips

map_data("county") %>% 
  left_join(dfips) ->
  dall

dall %>% 
  mutate(is_example = fips %in% data$fips) %>% 
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill=is_example), color="gray70") +
  coord_map() +
  scale_fill_manual(values=c("TRUE"="red", "FALSE"="gray90")) +
  labs(fill = "Present", x = "Longitude", y = "Latitude")
```

The following bar graph illustrates the variability between counties for which we have data and those for which we don't. This incomplete coverage motivated us to complement our analysis with data from RealtorDotCom.

```{r}
dall %>%
  mutate(is_present = fips %in% data$fips) %>%
  group_by(fips, is_present) %>%
  summarise(
    count = n(),
    percentage = (n() / nrow(dall)) * 100
  ) %>%
  ggplot(aes(x = is_present, y = count, fill = is_present)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("TRUE" = "steelblue", "FALSE" = "salmon")) +
  labs(
    title = "Count and Percentage of Presence and Absence of FIPS",
    x = "Presence",
    y = "Count",
    fill = "Presence"
  ) +
  theme_minimal()
```
The following statistics provide an overview of the data distribution, highlighting significant variation in rental prices, income levels, and property characteristics. Such variation underscores the need for robust multivariate analysis to disentangle the effects of different predictors. 

```{r}
# Select only numeric variables
numeric_data <- data %>% select_if(is.numeric)

# Summarize the statistics for numeric columns
summary_table <- data.frame(
  Variable = colnames(numeric_data),
  Mean = round(sapply(numeric_data, mean, na.rm = TRUE), 2),
  Variance = round(sapply(numeric_data, var, na.rm = TRUE), 2),
  Min = round(sapply(numeric_data, min, na.rm = TRUE), 2),
  Max = round(sapply(numeric_data, max, na.rm = TRUE), 2)
)

rownames(summary_table) <- 1:nrow(summary_table)

# Print the table nicely
kable(summary_table, format = "markdown", caption = "Summary Statistics for Numeric Variables")
```

One variable that caught our attention was age. At first, we were surprised and confused by the presence of ages such as 0 years old or very young ages. However, after further investigation, we discovered that the ACS collects data on every person living in each household to ensure a more comprehensive and accurate measure. As a result, the age variable includes values ranging from 0 to 97.

The following summary of the factor features provides further insight into our dataset. As indicated by the FIPS feature, we have data from every state in the country, as shown by the 51 unique values in this feature. California (represented by FIPS code 06) is the most common state in the sample dataset. Additionally, the "year" feature contains 18 levels, corresponding to 18 years of data in the sample, with 2014 being the most commonly represented year.

```{r}
# Select only factor (categorical) variables
factor_data <- data %>% select(-fips) %>%
  select_if(is.factor)

# Summarize the statistics for factor columns
summary_table2 <- data.frame(
  Variable = colnames(factor_data),
  `Number of Levels` = sapply(factor_data, function(col) length(unique(col))),
  `Most Frequent Level` = sapply(factor_data, function(col) names(sort(table(col), decreasing = TRUE)[1])),
  `Frequency of Most Frequent Level` = sapply(factor_data, function(col) max(table(col)))
)

# Print the table nicely
kable(summary_table2, format = "markdown", caption = "Summary Statistics for Factor Variables")
```


### Methodology

To analyze the determinants of rental prices, we adopted a multivariate linear regression model. This method allows us to evaluate the individual contribution of each explanatory variable while controlling for the effects of others. The steps taken in the analysis are as follows:

Variable Selection: Using domain knowledge and exploratory data analysis, we identified variables with potential relevance to rental price determination.

Model Specification:

The primary model is specified as:

$$
Y = \beta_0 + \gamma_i * year_i + \theta_j * state_j + \beta_k * X_k + \epsilon
$$

Where:

* $Y$ represents the dependent variable (Rent price).
* $X_1, X_2, X_3,\dots, X_n$ are the independent variables (e.g., [density, metro, hhincome, rooms, builtyr2, unitsstr, bedrooms, age, married, male, complete_plumbing, has_kitchen]).
* $year_i$ is the dummy variable for the year with $i \in \{1,\dots, 18\}$ as we're controlling for 18 years of data.
* $state_j$ is the dummy variable for the state with $j \in \{1,\dots, 51\}$ as we're controlling for all 50 states and the District of Columbia.
* $\beta_0$ is the intercept of the regression model.
* $\beta_1, \beta_2, \beta_3,\dots, \beta_n$ are the coefficients that represent the relationship between each independent variable and the dependent variable.
* $\gamma_i$ are the coefficients that represent the relationship between each year and the dependent variable.
* $\theta_j$ are the coefficients that represent the relationship between each state and the dependent variable.
* $\epsilon$ is the error term, capturing unobserved factors.

Model Estimation: To estimate the coefficients, we employed Ordinary Least Squares (OLS) regression. Diagnostic tests were conducted to validate the model assumptions:

Multicollinearity: Variance Inflation Factors (VIF) were calculated to ensure no strong multicollinearity among the predictors.
The model was implemented using the following code, which provided the estimated coefficients:

```{r, cache=FALSE}
data <- data %>% select(-fips)
fit.lm_acs <- lm(cpi_rent ~ ., data)
summary(fit.lm_acs)
```

To ensure robustness, we applied robust standard errors using the code below:

```{r, cache=FALSE}
coeftest(fit.lm_acs, vcov=vcovHC, type="HC0")
```

The VIF scores were computed to further validate the model:

```{r, cache=FALSE}
vif <- vif(fit.lm_acs)
print(vif)
```

Before analyzing the results, we note that all estimates are statistically significant. After applying robust standard errors, each estimated coefficient remains significant. Furthermore, we computed the Variance Inflation Factor (VIF) scores to ensure the validity of the model. All VIF scores are below 5, indicating no strong multicollinearity. This confirms that our model is both reliable and robust.

Model Overview:
The regression model included a total of 79 predictors and was fitted using a dataset with 13,341,750 observations. The adjusted R-squared of 0.4267 indicates that 42.67% of the variance in CPI Rent is explained by the included predictors. The F-statistic ($ 1.257e^5, p < 2.2e^{-16}$) demonstrates that the overall model is statistically significant.

Key Results:

Time Trends:
Yearly dummy variables were included to capture temporal trends. Statistically significant coefficients ($p < 0.001$) indicate clear yearly variation in CPI Rent. For example, CPI Rent increased significantly in 2020 ($\hat{\gamma_{2020}} = 49.41$, $p < 2e^{-16}$) and declined in 2011 ($\hat{\gamma_{2011}} = -6.86$, $p < 2e^{-16}$).

Population Density:
The coefficient for density was small but highly significant ($\hat{\beta_{density}} = 0.003$, $p < 2e^{-16}$), suggesting that higher density is associated with marginal increases in CPI Rent.

Metro Areas:
The presence of metro designation (`metro == TRUE`) substantially increased CPI Rent ($\hat{\beta_{metro}} = 166.5$,$p < 2e^{16}$).

State Effects:
State fixed effects (`fips_state`) showed considerable variation. For example, being in state 15 (Hawaii) significantly increased CPI Rent ($\hat{\theta_{15}} = 527.3$, $p < 2e^{-16}$) relative to the baseline.

Housing Characteristics:
Variables like the number of rooms ($\hat{\beta_{rooms}} = 22.44$, $p < 2e^{-16}$) and the presence of complete plumbing ($\hat{\beta_{plumbing}} = 125.0$, $p < 2e^{-16}$) were positively associated with CPI Rent. Conversely, older buildings (`builtyr2`) and lack of a kitchen had significant negative effects.

3. Variance Inflation Factor (VIF) Analysis:
The VIF values for all predictors were below 3, except for rooms (GVIF =  $3.039$), indicating no severe multicollinearity. This strengthens the robustness of the model's coefficient estimates.

4. Residual Analysis:
The residual standard error was $340.4$, indicating the average deviation between observed and predicted values. Residuals ranged from $-6,398.4$ to $4,859.9$, with a median near zero, suggesting an overall balanced fit.

5. Limitations and Future Research:
Although the model captures significant variance, $57.33%$ of CPI Rent variability remains unexplained. Including additional predictors like economic trends, housing policies, and neighborhood amenities could enhance model performance.





